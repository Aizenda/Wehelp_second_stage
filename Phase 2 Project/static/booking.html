<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking</title>
  <link rel="stylesheet" type="text/css" href='/static/css/booking.css'>
  <link rel="stylesheet" type="text/css" href="/static/css/login.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="modal__overlay"></div>
  <header class="header">
	<p class="header__title">台北一日遊</p>
    <nav class="header__nav">
      <button class="header__button--book" id="reserve">預定行程</button>
      <button class="header__button--signin" id="signin">登入/註冊</button>
    </nav>
  </header>
  <form id="signinForm" class="signin__content">
    <div class="signin__element__color"></div>
    <div class="signin__element__title">登入會員帳號</div>
    <img src="/static/imgs/8de46cdc235bdc9b370c21e0028a68e6.png" class="signin__content__img"/>
    <div class="signin__element__email">
        <input type="email" name="email" placeholder="輸入電子信箱" required/>
    </div>
    <div class="signin__element__password">
        <input type="password" name="password" placeholder="輸入密碼" required />
    </div>
    <div class="signin__element__request"></div>
    <div class="signin__content__buttom">
      <button type="submit" class="signin__content__buttom__style">登入帳號</button>
    </div>
    <div class="signin__element__link" class="signin__content__link">還沒有帳戶？點此註冊</div>
  </form>

  <form id="signupForm" class="signup__content">
    <div class="signup__element__color"></div>
    <div class="signup__element__title">註冊會員帳號</div>
    <img src="/static/imgs/8de46cdc235bdc9b370c21e0028a68e6.png" class="signin__content__img"/>
    <div class="signup__element__email">
      <input type="text" id="name" placeholder="輸入姓名" required />
    </div>
    <div class="signup__element__email">
        <input type="email" id="email" placeholder="輸入電子信箱" required />
    </div>
    <div class="signup__element__password">
        <input type="password" id="password" placeholder="輸入密碼" required />
    </div>
    <div class="signup__element__request"></div>
    <div class="signup__content__buttom">
      <button type="submit" class="signup__content__buttom__style">註冊帳號</button>
    </div>
    <div class="signup__element__link" class="signup__content__link">已經有帳戶了？點此登入</div>
    </div>
  </form>
  <hr class="header__separator" />
  <main id="booking" class="booking">
    <div class="booking__title"></div>
    <div class="booking__container">
    </div>
    <hr class="booking__separator" />
    
    <section id="contact-information" class="booking__contact">
      <div class="booking__contact-title"></div>
      <form class="booking__contact-form">
      </form>
    </section>
    <hr class="booking__contact-separator" />

    <section id="credit-card" class="booking__payment">
      <div class="booking__payment-title"></div>
      <form class="booking__payment-form">
        <div class="booking__contact__element"> 卡片號碼 :
          <div class="tpfield" id="card-number"></div>
        </div>
        <div class="booking__contact__element"> 過期時間 :
          <div class="tpfield" id="card-expiration-date"></div>
        </div>
        <div class="booking__contact__element"> 驗證密碼 :
          <div class="tpfield" id="card-ccv"></div>
        </div>
       </form>
    </section>
    <hr class="booking__payment-separator"/>

    <div id = "booking_pay-container" class="booking__pay">
      <div class="booking__pay__title"></div>
      <button class="booking__pay__button" type="submit">確認並付款</button>
    </div>
    
  </main>

  <footer class="footer">
    <p class="footer__container">Copyright © 2021 台北一日遊</p>
  </footer>
  <script src = '/static/js/loginmvc.js'></script>
	<script src = '/static/js/addcart.js'></script>
  <script src="https://js.tappaysdk.com/sdk/tpdirect/v5.14.0"></script>
  <script>
    TPDirect.setupSDK(159839, 'app_cBIyrT0fUpz4KwEIOiKDOpiyOxYrXWPZTEDYTpWr7t7nE0NQtbVnTBQU7wVq', 'sandbox')
    let submitButton = document.querySelector('.booking__pay__button');
    let fields = {
        number: {
            // css selector
            element: '#card-number',
            placeholder: '**** **** **** ****'
        },
        expirationDate: {
            // DOM object
            element: document.getElementById('card-expiration-date'),
            placeholder: 'MM / YY'
        }, 
        ccv: {
            element: '#card-ccv',
            placeholder: 'ccv'
        }
    }

    TPDirect.card.setup({
    fields: fields,
    styles: {
        // Style all elements
        'input': {
            'color': 'gray'
        },
        // Styling ccv field
        'input.ccv': {
            'font-size': '16px'
        },
        // Styling expiration-date field
        'input.expiration-date': {
            'font-size': '16px'
        },
        // Styling card-number field
        'input.card-number': {
            'font-size': '16px'
        },
        // style focus state
        ':focus': {
            'color': 'orange'
        },
        // style valid state
        '.valid': {
            'color': 'green'
        },
        // style invalid state
        '.invalid': {
            'color': 'red'
        },
        // Media queries
        // Note that these apply to the iframe, not the root window.
        '@media screen and (max-width: 400px)': {
            'input': {
                'color': 'orange'
            }
        }
    },
    // 此設定會顯示卡號輸入正確後，會顯示前六後四碼信用卡卡號
    isMaskCreditCardNumber: true,
    maskCreditCardNumberRange: {
        beginIndex: 6,
        endIndex: 11
    }
  });

  TPDirect.card.onUpdate(function (update) {
    if (update.canGetPrime) {
      submitButton.removeAttribute('disabled')
    } else {
      submitButton.setAttribute('disabled', true)
    }
  });

  const payButton = document.querySelector('.booking__pay__button');
  const contactForm = document.querySelector('.booking__contact-form');

  payButton.addEventListener('click', (event) => {
    event.preventDefault();

    let phone = document.querySelector('input[type=tel]').value;
    let price = document.querySelector('#price').textContent.split('新台幣 ')[1];
    let attractionName = document.querySelector('#attractionName').textContent;
    let date  = document.querySelector('#date').textContent;
    let timePeriod = document.querySelector('#time').textContent;
    let time = timePeriod === '早上 9 點到下午 4 點' ? '上半天' : '下半天';
    let attractionAddress = document.querySelector('#attractionAddress').textContent;
    let attractionId = localStorage.getItem('attractionId');
    let img = document.querySelector('.booking__container__img').src;

    // 原生 required 檢查
    if (!contactForm.checkValidity()) {
      contactForm.reportValidity();  // 顯示錯誤訊息泡泡
      return;
    }

    // TapPay 狀態確認
    const tappayStatus = TPDirect.card.getTappayFieldsStatus();
    if (!tappayStatus.canGetPrime) {
      alert('信用卡資訊無效，請重新確認');
      return;
    }

    TPDirect.card.getPrime((result) => {
      if (result.status !== 0) {
        alert('取得 Prime 失敗: ' + result.msg);
        return;
      }

      const prime = result.card.prime

      let contactData = {
        'name':localStorage.getItem('Name'),
        'email':localStorage.getItem('email'),
        'phone':phone
      };

      let order = {
        'price':price,
        'trip':{
          'attraction':{
            'id':attractionId,
            'name': attractionName,
            'address':attractionAddress,
            'image':img
          },
          'date':date,
          'time':time
        },
        'contact':contactData,
        'token':localStorage.getItem('token')
      }

      fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 'prime':prime, 'order': order }),
      })
      .then(res => res.json())
      .then(data => {
        if (data.data.payment.status === 0) {
          alert('付款成功')
          
        } else {
          alert('付款失敗：' + data.message);
        }
      })
      .catch(err => {
        alert('伺服器錯誤：' + err.message);
      });
    });
  });
  
  </script>
</body>
</html>